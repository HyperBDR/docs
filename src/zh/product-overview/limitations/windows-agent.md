# Windows Agent

## 重要提醒

### Windows Agent 与备份软件兼容性说明

Windows Agent 通过 Windows VSS（卷影复制服务）和磁盘过滤驱动程序来捕获 I/O 变动。然而，由于 Windows VSS 的限制，若两个软件在重叠的时间范围内同时调用 VSS 服务，可能导致 VSS 快照失败，从而无法满足预定的 RPO 要求。因此，Windows Agent 无法与使用相同机制的其他备份软件（如 Acronis、Veeam、Veritas、Commvault 等）同时运行。

如果系统中已安装类似机制的备份软件，建议在安装 Windows Agent 之前暂停或卸载该软件，以避免冲突。此外，用户可考虑咨询现有平台方，确认是否支持无代理方式进行数据备份，这样可以避免不同备份软件之间的冲突，确保系统备份和恢复的正常进行。

## 操作系统兼容性列表

| 操作系统         | 支持版本                |
|------------------|------------------------|
| Windows 7 Ultimate      | 64-bit |
| Windows 8 Professional  | 64-bit |
| Windows 10 Enterprise   | 64-bit |
| Windows 11 Enterprise   | 64-bit |
| Windows Server 2003     | SP2/R2 (64-bit) |
| Windows Server 2008     | 2008, 2008 R2 (64-bit) |
| Windows Server 2012     | 2012, 2012 R2 (64-bit) |
| Windows Server 2016     | 2016 (64-bit) |
| Windows Server 2019     | 2019 (64-bit) |
| Windows Server 2022     | 2022 (64-bit) |

::: warning
点击[云平台支持矩阵](https://oneprocloud.feishu.cn/sheets/VRqksSPEPhRTPStp3kVcItXNnyh?sheet=Y9fpqO)查看兼容
性列表及最新支持状态。
:::

## 支持和限制条件

### 基本要求
   - **CPU:** x86-64 位处理器
      - **CPU使用控制:** 您可以通过控制台源端同步配置进行配置。默认情况下，CPU使用限制设置为30%。
      - **提高同步速度:** 如果您的网络带宽足够，增加CPU使用限制可提高对象存储模式下的同步速度。
      - 注意:增加CPU使用限制可能会在计算机性能较低或同时运行其他CPU密集型任务时导致系统变慢或不稳定。因此，在增加CPU使用限制之前，请评估系统性能和资源利用情况。
   - **内存要求:**
      - 为确保DiskSyncAgent服务的正常运行，建议至少有1GB可用内存。
      - DiskSyncAgent服务通常占用220-350MB的内存。内存不足可能会导致服务运行缓慢或崩溃。
   - **代理软件空间:** 为确保软件的正常安装与运行，建议至少保留200MB的空闲空间。
   - **网络连接:** 为确保与目标端点连接的稳定性与速度，建议使用至少10Mbps的网络连接。
   - **系统固件:** 为确保与软件的兼容性，需要安装BIOS或UEFI固件。
   - **虚拟化支持:** DiskSyncAgent支持完全虚拟化，但对半虚拟化（如 XenServer）的支持有限，可能需要在最终启动时进行手动修复。

### 磁盘空间建议

Windows Agent使用Windows VSS创建一致的快照，无需中断系统操作，确保数据完整性并支持快速恢复，从而提高同步效率和业务连续性。因此，在同步过程中，需要满足以下磁盘空间要求。

   - **VSS快照的推荐空闲空间**: 建议用于VSS快照的卷应至少保留10%的空闲空间。如果卷数据频繁更新，建议增加预留空闲空间的比例，以避免由于空间不足导致同步失败。

   - **VSS预检查的最小空间要求**: Windows Agent 在执行 VSS 预检查时，统一要求分区预留至少 320 MB 空间供 VSS 使用。如果分区为系统安装过程生成的保留分区（如 EFI 或恢复分区），建议先去掉该分区的盘符后再进行同步，以避免 VSS 检查失败。

       - 参考文档：[Microsoft 官方文档 - Registry Keys for Backup and Restore](https://learn.microsoft.com/en-us/windows/win32/backup/registry-keys-for-backup-and-restore?utm_source=chatgpt.com)

   - **高磁盘I/O对VSS快照的影响**: 在主机同步期间，过多的磁盘I/O可能导致VSS快照数据无法正常维护。Windows系统优先访问业务数据，可能会丢弃VSS快照的增量数据，导致同步失败。这种问题通常发生在数据备份、大型数据库事务、表索引更新、全盘搜索或临时表操作过多时。

   - **应对高磁盘I/O导致同步失败的推荐措施**:

     1. **减少磁盘I/O**: 调整业务操作，例如在同步期间暂停备份任务，或优化SQL查询以减少磁盘I/O。
     2. **指定非同步磁盘**: 可以将一个磁盘指定为非同步磁盘，或者增加新的磁盘并分配专用于VSS快照数据的卷。然后，配置`VSS_SPEC_MAX_?`设置，将VSS存储定向到专用卷，帮助缓解高I/O影响，但可能无法完全解决问题。

### 支持与限制条件

| 条件 | 支持情况 | 不支持情况 |
|------|----------|------------|
| 用户权限 | 支持：管理员用户，或域控用户但具有本地管理员权限 | 不支持：非管理员用户 |
| 文件系统类型 | 支持：NTFS | 不支持：其他文件系统，例如FAT16, FAT32, ReFS等 |
| 分区类型 | 支持：主分区/扩展分区、MBR/GPT、基本磁盘、动态磁盘（简单卷和跨区卷） | 不支持：动态磁盘（镜像卷、RAID卷）、动态磁盘作为启动分区 |
| VSS快照 | 支持：卷保留≥10%空闲空间，VSS服务正常，NTFS支持VSS同步 | 不支持：空间不足、VSS服务异常、非NTFS文件系统VSS同步 |
| 磁盘数量 | 支持：≤32个磁盘 | 不支持：超过32个磁盘 |
| 离线磁盘同步 | 不适用 | 不支持：所有离线磁盘同步 |
| 共享磁盘 | 支持：仅一台主机同步共享磁盘，其他主机可排除 | 不支持：多主机同时同步同一共享磁盘 |
| 虚拟化 | 支持：完全虚拟化 | 半虚拟化（如XenServer，可能需要手动修复） |
| iSCSI磁盘 | 支持 | 不适用 |
| 语言支持 | 中文、英文、西班牙语 (Español) | 本产品支持的字符集为 Code Page 437（英文及部分西欧语言）和 Code Page 936（简体中文及常用符号），目前仅对西班牙语进行了特殊适配，其他语言（如法语、德语、俄语、日语、韩语等）暂不支持。 |
| 时间同步服务 | 需要 | 不适用 |

### 磁盘卷要求
   - 支持的磁盘数量不超过32个。
   - 不支持源磁盘的离线同步。所有磁盘必须在同步前保持在线。您可以通过源配置文件配置不需要同步的磁盘。
   - 不需要同步的磁盘（除启动磁盘外）可通过配置进行排除。参考配置文件中的`EXCLUDE_DISKS`配置项。排除的磁盘可以离线。注意：修改`EXCLUDE_DISKS`配置项必须在首次启动服务（节点注册）之前完成。节点注册完成后，无法修改该配置项。如需修改，请清除资源并重新注册节点。
   - 如果源端有共享磁盘挂载到多个主机，在迁移过程中只能选择其中一台主机的共享磁盘进行同步。其他主机上的共享磁盘可以通过`EXCLUDE_DISK`配置项排除。
   - 卷的空闲空间比例应不低于3%。如果系统增量数据较大，需额外预留空间用于存储VSS快照。空间不足可能导致快照异常，进而导致同步失败。
   - 支持同步简单卷和分区卷，但不支持带有区域的卷、镜像卷或RAID卷。
   - Windows动态磁盘不能作为系统启动分区。

### 文件系统与卷快照要求
   - NTFS文件系统支持VSS同步模式，仅同步有效数据。
   - 原始设备或其他非NTFS文件系统不支持VSS模式，基于实际磁盘容量同步。
   - 在VSS模式下，源主机上的VSS服务必须正常运行。您可以使用Windows提供的`vssadmin`命令行工具来创建和删除快照。
   - 在云磁盘模式下，`MsiscsiService`服务必须正常运行。
   - 在源主机的同步过程中，请勿手动删除Windows VSS快照，否则会导致同步失败，并需要重新启动全量同步。

### 网络要求
   - 在云磁盘模式下，源主机需要能够访问目标端点的3260/13260端口，推荐使用S3Block作为传输协议，原有iSCSI协议已经废弃。
   - 在云磁盘模式下，如果源磁盘包含iSCSI磁盘，请谨慎操作，不要更改原始发起器名称，以避免影响业务系统的正常运行。
   - 在云磁盘模式同步时，源主机到目标主机的网络带宽应不少于5Mbps，以确保目标磁盘的稳定性。确保网络稳定、低延迟和低抖动。
   - 支持代理模式，可在安装和启动阶段通过界面设置正确的代理服务器和端口。

### 系统补丁要求
   - 为确保DiskSyncAgent服务正常运行，需要在Windows 2008 32位、Windows 2008 64位和Windows 2008 R2 64位系统上安装补丁KB4474419。安装补丁后，请重启系统再启动DiskSyncAgent服务。有关补丁安装方法，请参考附录。

### 安全软件要求
   - 如果主机已安装安全软件，建议在同步前完全禁用安全软件（对于某些软件，退出功能可能无法完全禁用该软件。如果不确定安全软件是否可以完全禁用，建议先卸载相关软件）。
   - 如果无法完全禁用安全软件，在安装和启动Agent服务时请注意安全软件的警告信息。如果弹出警告信息窗口，请务必对所有操作设置信任，避免安全软件拦截或警告。请勿在安装和启动Windows Agent时暂时禁用安全软件，因为这可能会损害Agent服务。如果发生此问题，需重启主机以恢复服务。有关影响Agent数据同步的安全软件列表，请参考附录2。

## 常见问题

**Windows Agent同步失败解决方案（153315 / 154000 / 154001 等）**

在使用Windows Agent时，常见的错误代码包括153315、154000、154001等。这些错误通常与Windows VSS（卷影复制服务）VolSnap事件相关。以下是对这些问题的详细分析：

1. **VSS保留存储空间耗尽**：当VSS保留存储空间快速耗尽时，会导致自动快照清理。此问题可以通过多个事件ID出现，例如事件ID 23（VS_DIFF_AREA_CREATE_FAILED_LOW_DISK_SPACE）和事件ID 36（VS_ABORT_NO_DIFF_AREA_SPACE_USER_IMPOSED），也可能会以其他事件ID出现。

2. **差异数据写入失败**：当系统无法处理差异数据写入时，会触发快照清理以确保正常的I/O操作继续进行。为了防止因高I/O或存储空间不足导致的快照意外删除，微软建议将VSS快照移动到空间更充足的磁盘上，或者使用不参与VSS快照的独立磁盘。这有助于确保快照的稳定性和业务连续性。此问题通常与事件ID 25（VS_ABORT_SNAPSHOTS_OUT_OF_DIFF_AREA）相关，但也可能与其他事件ID一起发生。

::: tip
从 v6.2.0 版本开始，如果发生 VSS 异常（例如，由于高 I/O 负载导致 VSS 快照被删除），Windows 代理将无法继续读取增量数据。在这种情况下，下次同步触发时将自动执行全量同步，以确保数据完整性。
:::

#### 参考文献

- [微软关于事件 ID 23 的文档](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd364930(v=ws.10)?redirectedfrom=MSDN)
- [微软关于事件 ID 36 的文档](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364636(v=ws.10))
- [微软关于事件 ID 25 的论坛](https://learn.microsoft.com/en-us/archive/msdn-technet-forums/1886c270-fc4c-41b5-b25f-3a8d52a4a8a7)
- [Diff Area Integrity](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2008-r2-and-2008/dd364947(v=ws.10))
- 更多的与VolSnap相关的事件ID请查看：

| 事件 ID | 来源    | 消息 |
|---------|---------|------|
| 1  | VolSnap | 无法在卷 %3 上创建卷 %2 的影子副本差异区域文件。 |
| 2  | VolSnap | 无法创建卷 %2 的影子副本，因为指定为差异区域一部分的卷 %3 不是 NTFS 卷，或者在尝试确定该卷的文件系统类型时遇到错误。 |
| 3  | VolSnap | 无法锁定卷 %3 上的影子副本差异区域文件的位置，以创建卷 %2 的影子副本。 |
| 14 | VolSnap | 由于卷 %3 上的 IO 故障，卷 %2 的影子副本已中止。 |
| 16 | VolSnap | 由于包含影子副本差异区域文件的卷 %3 被强制卸载，卷 %2 的影子副本已中止。 |
| 23 | VolSnap | 由于卷 %3 上的磁盘空间不足，无法创建卷 %2 的影子副本。差异区域文件创建失败。 |
| 24 | VolSnap | 由于卷 %3 上的磁盘空间不足，无法扩展 %2 的影子副本差异区域。因此，卷 %2 的所有影子副本都有被删除的风险。 |
| 25 | VolSnap | 由于差异区域文件未能及时增长，卷 %2 的影子副本已中止。请考虑减少系统上的 IO 负载，以避免此问题再次发生。 |
| 33 | VolSnap | 删除了卷 %2 的最旧影子副本，以保持影子副本的磁盘空间使用量低于用户定义的限制。 |
| 35 | VolSnap | 由于差异区域文件未能增长，卷 %2 的影子副本已中止。 |
| 36 | VolSnap | 由于用户设定的限制导致差异区域文件无法增长，卷 %2 的影子副本已中止。 |
| 38 | VolSnap | 用户设定的限制阻止了使用卷 %3 上的磁盘空间来扩展 %2 的影子副本差异区域。因此，卷 %2 的所有影子副本都有被删除的风险。 |
| 40 | VolSnap | 由于卷 %3 已被卸载，卷 %2 的影子副本已中止。 |
| 41 | VolSnap | 在为卷 %2 准备新的影子副本时，卷 %3 上的影子副本存储没有足够大的连续块。请考虑删除影子副本存储卷上的不必要文件，或使用不同的影子副本存储卷。 |
